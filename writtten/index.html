<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <title>WordJournal · Feed</title>
        <link rel="stylesheet" href="styles.css">
    </head>
<body>
    <header>
        <div class="logo">WordJournal</div>
        <nav>
            <a class="active" href="index.html">Feed</a>
            <a href="explore.html">Explore</a>
            <a href="profile.html">Profile</a>
            <a href="settings.html">Settings</a>
            <button id="logoutButton" class="composer-toggle" style="border:none;padding:0;">Log out</button>
        </nav>
    </header>

    <main>
        <section class="panel">
            <h2>Feed</h2>
            <p id="feedHint" class="muted">Loading posts…</p>
            <button id="toggleComposer" class="composer-toggle">Write a new post</button>

            <form id="composer" class="hidden">
                <label for="postBody">Post</label>
                <textarea id="postBody" name="postBody" placeholder="Put your thoughts here." aria-label="Post body"></textarea>
                <div class="form-actions">
                    <button type="submit">Post to feed</button>
                </div>
            </form>

            <ul id="feedList" class="feed-list"></ul>
        </section>

        <aside class="panel">
            <h2>Following</h2>
            <p class="muted" id="followingHint">No subscriptions yet.</p>
            <ul id="followingList" class="feed-list"></ul>
        </aside>
    </main>

    <footer>Wired for clarity · Source Serif 4 throughout</footer>

    <script>
        const toggleComposer = document.getElementById('toggleComposer');
        const composer = document.getElementById('composer');
        const feedList = document.getElementById('feedList');
        const postBody = document.getElementById('postBody');
        const feedHint = document.getElementById('feedHint');
        const logoutButton = document.getElementById('logoutButton');
        const followingList = document.getElementById('followingList');
        const followingHint = document.getElementById('followingHint');

        async function ensureLoggedIn() {
            try {
                const res = await fetch('/api/me');
                if (!res.ok) {
                    window.location.href = 'login.html';
                }
            } catch (e) {
                console.error(e);
                window.location.href = 'login.html';
            }
        }

        function getProfileUrlForPost(post) {
            const username = post.username;
            if (!username) {
                return 'profile.html';
            }
            return `profile.html?u=${encodeURIComponent(username)}`;
        }

        async function loadPosts() {
            try {
                const res = await fetch('/api/posts');
                if (!res.ok) throw new Error('Failed to load posts');
                const posts = await res.json();

                feedList.innerHTML = '';
                if (!posts.length) {
                    feedHint.textContent = 'No posts yet. Start the conversation by drafting the first update.';
                    return;
                }

                feedHint.textContent = '';
                for (const post of posts) {
                    const item = document.createElement('li');
                    item.className = 'panel';

                    if (post.profile_color) {
                        item.style.borderColor = post.profile_color;
                    }

                    const header = document.createElement('div');
                    header.className = 'post-header';

                    const author = document.createElement('button');
                    author.type = 'button';
                    author.className = 'post-author';
                    author.textContent = post.display_name || post.username || 'You';
                    author.addEventListener('click', () => {
                        window.location.href = getProfileUrlForPost(post);
                    });

                    const meta = document.createElement('div');
                    meta.className = 'post-meta';
                    if (post.created_at) {
                        const when = new Date(post.created_at);
                        meta.textContent = when.toLocaleString();
                    }

                    const bodyEl = document.createElement('div');
                    bodyEl.className = 'post-body';

                    const lines = String(post.body || '').split('\n');
                    const maxLines = 25;
                    if (lines.length > maxLines) {
                        const first = lines.slice(0, maxLines).join('\n');
                        const rest = lines.slice(maxLines).join('\n');

                        const visibleSpan = document.createElement('span');
                        visibleSpan.textContent = first + '\n';

                        const hiddenSpan = document.createElement('span');
                        hiddenSpan.textContent = rest;
                        hiddenSpan.style.display = 'none';

                        bodyEl.appendChild(visibleSpan);
                        bodyEl.appendChild(hiddenSpan);

                        const readMore = document.createElement('button');
                        readMore.type = 'button';
                        readMore.className = 'post-read-more';
                        readMore.textContent = 'Read more';
                        readMore.addEventListener('click', () => {
                            hiddenSpan.style.display = 'inline';
                            readMore.remove();
                        });

                        header.appendChild(author);
                        header.appendChild(meta);
                        item.appendChild(header);
                        item.appendChild(bodyEl);
                        item.appendChild(readMore);
                    } else {
                        bodyEl.textContent = post.body;
                        header.appendChild(author);
                        header.appendChild(meta);
                        item.appendChild(header);
                        item.appendChild(bodyEl);
                    }

                    feedList.appendChild(item);
                }
            } catch (e) {
                console.error(e);
                feedHint.textContent = 'Unable to load posts right now.';
            }
        }

        toggleComposer.addEventListener('click', () => {
            composer.classList.toggle('hidden');
            if (!composer.classList.contains('hidden')) {
                postBody.focus();
            }
        });

        composer.addEventListener('submit', async (event) => {
            event.preventDefault();
            const text = postBody.value.trim();
            if (!text) return;

            try {
                const res = await fetch('/api/posts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ body: text })
                });
                if (!res.ok) throw new Error('Failed to save post');
                const created = await res.json();

                // Re-render single new post using same formatting rules
                const item = document.createElement('li');
                item.className = 'panel';

                if (created.profile_color) {
                    item.style.borderColor = created.profile_color;
                }

                const header = document.createElement('div');
                header.className = 'post-header';

                const author = document.createElement('button');
                author.type = 'button';
                author.className = 'post-author';
                author.textContent = created.display_name || created.username || 'You';
                author.addEventListener('click', () => {
                    window.location.href = getProfileUrlForPost(created);
                });

                const meta = document.createElement('div');
                meta.className = 'post-meta';
                if (created.created_at) {
                    const when = new Date(created.created_at);
                    meta.textContent = when.toLocaleString();
                }

                const bodyEl = document.createElement('div');
                bodyEl.className = 'post-body';

                const lines = String(created.body || '').split('\n');
                const maxLines = 25;
                if (lines.length > maxLines) {
                    const first = lines.slice(0, maxLines).join('\n');
                    const rest = lines.slice(maxLines).join('\n');

                    const visibleSpan = document.createElement('span');
                    visibleSpan.textContent = first + '\n';

                    const hiddenSpan = document.createElement('span');
                    hiddenSpan.textContent = rest;
                    hiddenSpan.style.display = 'none';

                    bodyEl.appendChild(visibleSpan);
                    bodyEl.appendChild(hiddenSpan);

                    const readMore = document.createElement('button');
                    readMore.type = 'button';
                    readMore.className = 'post-read-more';
                    readMore.textContent = 'Read more';
                    readMore.addEventListener('click', () => {
                        hiddenSpan.style.display = 'inline';
                        readMore.remove();
                    });

                    header.appendChild(author);
                    header.appendChild(meta);
                    item.appendChild(header);
                    item.appendChild(bodyEl);
                    item.appendChild(readMore);
                } else {
                    bodyEl.textContent = created.body;
                    header.appendChild(author);
                    header.appendChild(meta);
                    item.appendChild(header);
                    item.appendChild(bodyEl);
                }

                feedList.prepend(item);

                postBody.value = '';
                composer.classList.add('hidden');
                if (feedHint) feedHint.textContent = '';
            } catch (e) {
                console.error(e);
                alert('Could not save the post. Please try again.');
            }
        });

        async function loadFollowing() {
            try {
                const res = await fetch('/api/subscriptions');
                if (!res.ok) throw new Error('Failed to load subscriptions');
                const subs = await res.json();

                followingList.innerHTML = '';
                if (!subs.length) {
                    followingHint.textContent = 'No subscriptions yet.';
                    return;
                }

                followingHint.textContent = '';
                for (const sub of subs) {
                    const li = document.createElement('li');
                    const link = document.createElement('button');
                    link.type = 'button';
                    link.className = 'post-author';
                    link.textContent = sub.display_name || sub.username;
                    link.addEventListener('click', () => {
                        window.location.href = `profile.html?u=${encodeURIComponent(sub.username)}`;
                    });
                    li.appendChild(link);
                    followingList.appendChild(li);
                }
            } catch (e) {
                console.error(e);
                followingHint.textContent = 'Unable to load subscriptions.';
            }
        }

        logoutButton.addEventListener('click', async () => {
            try {
                await fetch('/api/auth/logout', { method: 'POST' });
            } catch (e) {
                console.error(e);
            }
            window.location.href = 'login.html';
        });

        // Initial load
        (async () => {
            await ensureLoggedIn();
            await loadPosts();
            await loadFollowing();
        })();
    </script>
</body>
</html>


<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Written · Feed</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <header>
        <div class="logo">Written</div>
        <nav>
            <a class="active" href="index.html">Feed</a>
            <a href="explore.html">Explore</a>
            <a href="profile.html">Profile</a>
            <a href="settings.html">Settings</a>
            <button id="logoutButton" class="composer-toggle" style="border:none;padding:0;">Log out</button>
        </nav>
    </header>

    <main>
        <section class="panel">
            <h2>Feed</h2>
            <p id="feedHint" class="muted">Loading posts…</p>
            <button id="toggleComposer" class="composer-toggle">Write a new post</button>

            <form id="composer" class="hidden">
                <label for="postBody">Post</label>
                <textarea id="postBody" name="postBody" placeholder="Put your thoughts here." aria-label="Post body"></textarea>
                <div class="form-actions">
                    <button type="submit">Post to feed</button>
                </div>
            </form>

            <ul id="feedList" class="feed-list"></ul>
        </section>

        <aside class="panel">
            <h2>Next step</h2>
            <p class="muted">Posts and profile fields now save to your database. Extend these endpoints as the product grows.</p>
            <p class="muted">Everything stays squared and monochrome so future changes remain simple to see.</p>
        </aside>
    </main>

    <footer>Wired for clarity · Source Serif 4 throughout</footer>

    <script>
        const toggleComposer = document.getElementById('toggleComposer');
        const composer = document.getElementById('composer');
        const feedList = document.getElementById('feedList');
        const postBody = document.getElementById('postBody');
        const feedHint = document.getElementById('feedHint');
        const logoutButton = document.getElementById('logoutButton');

        async function ensureLoggedIn() {
            try {
                const res = await fetch('/api/me');
                if (!res.ok) {
                    window.location.href = 'login.html';
                }
            } catch (e) {
                console.error(e);
                window.location.href = 'login.html';
            }
        }

        async function loadPosts() {
            try {
                const res = await fetch('/api/posts');
                if (!res.ok) throw new Error('Failed to load posts');
                const posts = await res.json();

                feedList.innerHTML = '';
                if (!posts.length) {
                    feedHint.textContent = 'No posts yet. Start the conversation by drafting the first update.';
                    return;
                }

                feedHint.textContent = '';
                for (const post of posts) {
                    const item = document.createElement('li');
                    item.className = 'panel';
                    item.textContent = post.body;
                    feedList.appendChild(item);
                }
            } catch (e) {
                console.error(e);
                feedHint.textContent = 'Unable to load posts right now.';
            }
        }

        toggleComposer.addEventListener('click', () => {
            composer.classList.toggle('hidden');
            if (!composer.classList.contains('hidden')) {
                postBody.focus();
            }
        });

        composer.addEventListener('submit', async (event) => {
            event.preventDefault();
            const text = postBody.value.trim();
            if (!text) return;

            try {
                const res = await fetch('/api/posts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ body: text })
                });
                if (!res.ok) throw new Error('Failed to save post');
                const created = await res.json();

                const item = document.createElement('li');
                item.className = 'panel';
                item.textContent = created.body;
                feedList.prepend(item);

                postBody.value = '';
                composer.classList.add('hidden');
                if (feedHint) feedHint.textContent = '';
            } catch (e) {
                console.error(e);
                alert('Could not save the post. Please try again.');
            }
        });

        logoutButton.addEventListener('click', async () => {
            try {
                await fetch('/api/auth/logout', { method: 'POST' });
            } catch (e) {
                console.error(e);
            }
            window.location.href = 'login.html';
        });

        // Initial load
        (async () => {
            await ensureLoggedIn();
            await loadPosts();
        })();
    </script>
</body>
</html>


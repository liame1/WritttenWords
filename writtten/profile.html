<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Written Â· Profile</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="single-column">
    <header>
        <div class="logo">Written</div>
        <nav>
            <a href="index.html">Feed</a>
            <a href="explore.html">Explore</a>
            <a class="active" href="profile.html">Profile</a>
            <a href="settings.html">Settings</a>
            <button id="logoutButton" class="composer-toggle" style="border:none;padding:0;">Log out</button>
        </nav>
    </header>

    <main>
        <div class="banner" id="profileBanner">
            <img id="bannerImage" alt="Banner" style="display:none;">
        </div>

        <section class="panel">
            <h2 id="profileName">Display name</h2>
            <p class="muted">No avatar, no clutter. This profile keeps a single name and top banner, both controlled from settings.</p>
            <a id="adjustProfileLink" class="button-link" href="settings.html">Adjust profile fields</a>
            <button id="subscribeButton" class="composer-toggle" type="button" style="margin-top:1rem;"></button>
        </section>

        <section class="panel">
            <h2 id="postsHeading">Your posts</h2>
            <ul id="profilePosts" class="feed-list"></ul>
        </section>
    </main>

    <footer>Profiles now reflect saved data from the backend</footer>

    <script>
        const banner = document.getElementById('profileBanner');
        const bannerImage = document.getElementById('bannerImage');
        const nameHeading = document.getElementById('profileName');
        const profilePosts = document.getElementById('profilePosts');
        const postsHeading = document.getElementById('postsHeading');
        const adjustProfileLink = document.getElementById('adjustProfileLink');
        const subscribeButton = document.getElementById('subscribeButton');
        const logoutButton = document.getElementById('logoutButton');

        let currentUser = null;

        function getQueryUsername() {
            const params = new URLSearchParams(window.location.search);
            const u = params.get('u');
            if (!u) return null;
            return u.trim();
        }

        async function ensureLoggedIn() {
            try {
                const res = await fetch('/api/me');
                if (!res.ok) {
                    window.location.href = 'login.html';
                    return;
                }
                currentUser = await res.json();
            } catch (e) {
                console.error(e);
                window.location.href = 'login.html';
            }
        }

        function isViewingSelf() {
            const u = getQueryUsername();
            if (!u) return true;
            if (!currentUser) return true;
            return u === currentUser.username;
        }

        async function syncProfile() {
            const username = getQueryUsername();
            try {
                let data;
                if (!username || isViewingSelf()) {
                    const res = await fetch('/api/profile');
                    if (!res.ok) throw new Error('Failed to load profile');
                    data = await res.json();
                } else {
                    const res = await fetch(`/api/users/${encodeURIComponent(username)}/profile`);
                    if (!res.ok) throw new Error('Failed to load user profile');
                    data = await res.json();
                }

                if (data.display_name) {
                    nameHeading.textContent = data.display_name;
                } else if (data.username) {
                    nameHeading.textContent = data.username;
                }

                // Try to load banner image
                const imgRes = await fetch(
                    !username || isViewingSelf()
                        ? '/api/profile/banner'
                        : `/api/users/${encodeURIComponent(username)}/banner`
                );
                if (imgRes.ok) {
                    const blob = await imgRes.blob();
                    const url = URL.createObjectURL(blob);
                    bannerImage.src = url;
                    bannerImage.style.display = 'block';
                } else {
                    bannerImage.style.display = 'none';
                }

                // Control visibility of adjust link vs subscribe button and posts heading
                if (isViewingSelf()) {
                    adjustProfileLink.style.display = 'inline-block';
                    subscribeButton.style.display = 'none';
                    postsHeading.textContent = 'Your posts';
                } else {
                    adjustProfileLink.style.display = 'none';
                    subscribeButton.style.display = 'inline-block';
                    postsHeading.textContent = 'Posts';
                    await syncSubscriptionButton();
                }
            } catch (e) {
                console.error(e);
            }
        }

        async function syncSubscriptionButton() {
            const username = getQueryUsername();
            if (!username || isViewingSelf()) return;
            try {
                const res = await fetch(`/api/subscription/status?username=${encodeURIComponent(username)}`);
                if (!res.ok) throw new Error('Failed to check subscription status');
                const data = await res.json();
                subscribeButton.textContent = data.followed ? 'Unsubscribe' : 'Subscribe';
            } catch (e) {
                console.error(e);
                subscribeButton.textContent = 'Subscribe';
            }
        }

        subscribeButton.addEventListener('click', async () => {
            const username = getQueryUsername();
            if (!username || isViewingSelf()) return;
            const currentlyUnsubscribing = subscribeButton.textContent === 'Unsubscribe';
            try {
                const method = currentlyUnsubscribing ? 'DELETE' : 'POST';
                const res = await fetch('/api/subscribe', {
                    method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username })
                });
                if (!res.ok) throw new Error('Failed to update subscription');
                await syncSubscriptionButton();
            } catch (e) {
                console.error(e);
                alert('Could not update subscription. Please try again.');
            }
        });

        async function loadProfilePosts() {
            const username = getQueryUsername();
            try {
                const res = await fetch(
                    !username || isViewingSelf()
                        ? '/api/profile/posts'
                        : `/api/users/${encodeURIComponent(username)}/posts`
                );
                if (!res.ok) throw new Error('Failed to load profile posts');
                const posts = await res.json();

                profilePosts.innerHTML = '';
                for (const post of posts) {
                    const li = document.createElement('li');
                    li.className = 'panel';

                    const bodyEl = document.createElement('div');
                    bodyEl.className = 'post-body';
                    bodyEl.textContent = post.body;

                    li.appendChild(bodyEl);
                    profilePosts.appendChild(li);
                }
            } catch (e) {
                console.error(e);
            }
        }

        logoutButton.addEventListener('click', async () => {
            try {
                await fetch('/api/auth/logout', { method: 'POST' });
            } catch (e) {
                console.error(e);
            }
            window.location.href = 'login.html';
        });

        (async () => {
            await ensureLoggedIn();
            await syncProfile();
            await loadProfilePosts();
        })();
    </script>
</body>
</html>

